name: Update Game Links

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Data and Create Files
        run: |
          mkdir -p links

          # 1. 处理游戏列表
          GAMES=(
            "Arknights;GzD1CpaWgmSq1wew"
            "Endfield;6LL0KJuqHBVz33WK"
            "POPUCOM;Vp2jukCCSUGztqli"
          )

          for game in "${GAMES[@]}"; do
            NAME=$(echo $game | cut -d';' -f1)
            CODE=$(echo $game | cut -d';' -f2)
            
            echo "正在获取游戏数据: $NAME..."

            curl -s -X POST "https://launcher.hypergryph.com/api/proxy/batch_proxy" \
              -H "Content-Type: application/json" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" \
              -d "{
                \"proxy_reqs\": [
                  {
                    \"kind\": \"get_latest_game\",
                    \"get_latest_game_req\": {
                      \"appcode\": \"$CODE\",
                      \"channel\": \"1\",
                      \"sub_channel\": \"1\",
                      \"version\": \"\",
                      \"launcher_appcode\": \"\"
                    }
                  }
                ]
              }" | jq -S 'del(.. | .timestamp?)' > "links/${NAME}.json"
              # 注意这里的 jq 逻辑：del(.. | .timestamp?) 会递归删除 JSON 中所有层级的 timestamp 字段
          done

          # 2. 处理启动器 (GET 请求)
          echo "正在获取启动器数据..."
          curl -s -X GET "https://launcher.hypergryph.com/api/launcher/get_latest?appcode=abYeZZ16BPluCFyT&channel=1" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" \
            | jq -S 'del(.timestamp?)' > "links/HypergryphLauncher.json"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add links/*.json
          
          # 只提取真正变动的文件名
          UPDATED_FILES=$(git diff --name-only --staged | xargs -n1 basename | paste -sd ", " -)

          if [ -z "$UPDATED_FILES" ]; then
            echo "由于排除了时间戳，内容无实质性变化，跳过提交。"
          else
            echo "检测到实质性变动的文件: $UPDATED_FILES"
            git commit -m "自动更新: $UPDATED_FILES"
            git pull --rebase origin main
            git push origin main
          fi
