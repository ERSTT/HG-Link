name: Update Game Links

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch and Compare
        run: |
          mkdir -p links
          FULL_LOG=""

          # 定义处理函数
          process_game() {
            local NAME=$1
            local CODE=$2
            local FILE="links/${NAME}.json"
            local TEMP_FILE="temp_${NAME}.json"
            
            echo "--- 正在处理 $NAME ---"
            
            # 抓取数据并排序保存
            curl -s -X POST "https://launcher.hypergryph.com/api/proxy/batch_proxy" \
              -H "Content-Type: application/json" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" \
              -d "{\"proxy_reqs\":[{\"kind\":\"get_latest_game\",\"get_latest_game_req\":{\"appcode\":\"$CODE\",\"channel\":\"1\",\"sub_channel\":\"1\",\"version\":\"\",\"launcher_appcode\":\"\"}}]}" | jq -S '.' > "$TEMP_FILE"

            # 修正后的路径：proxy_rsps -> get_latest_game_rsp -> version
            NEW_VER=$(jq -r '.proxy_rsps[0].get_latest_game_rsp.version // empty' "$TEMP_FILE")
            
            if [ -f "$FILE" ]; then
              OLD_VER=$(jq -r '.proxy_rsps[0].get_latest_game_rsp.version // empty' "$FILE")
            else
              OLD_VER="None"
            fi

            echo "[$NAME] 旧版本: $OLD_VER | 新版本: $NEW_VER"

            if [ -n "$NEW_VER" ] && [ "$NEW_VER" != "$OLD_VER" ]; then
              mv "$TEMP_FILE" "$FILE"
              FULL_LOG="${FULL_LOG}${NAME} ($OLD_VER -> ${NEW_VER}) "
            else
              rm -f "$TEMP_FILE"
            fi
            
            # 将累计的日志写回环境变量
            echo "FINAL_LOG=$FULL_LOG" >> $GITHUB_ENV
          }

          # 1. 运行游戏处理
          process_game "Arknights" "GzD1CpaWgmSq1wew"
          process_game "Endfield" "6LL0KJuqHBVz33WK"
          process_game "POPUCOM" "Vp2jukCCSUGztqli"

          # 2. 特殊处理启动器 (GET 请求)
          echo "--- 正在处理 Launcher ---"
          L_FILE="links/HypergryphLauncher.json"
          L_TEMP="temp_launcher.json"
          curl -s -X GET "https://launcher.hypergryph.com/api/launcher/get_latest?appcode=abYeZZ16BPluCFyT&channel=1" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" | jq -S '.' > "$L_TEMP"
          
          L_NEW_VER=$(jq -r '.version // empty' "$L_TEMP")
          L_OLD_VER=$( [ -f "$L_FILE" ] && jq -r '.version // empty' "$L_FILE" || echo "None" )

          echo "[Launcher] 旧版本: $L_OLD_VER | 新版本: $L_NEW_VER"

          if [ -n "$L_NEW_VER" ] && [ "$L_NEW_VER" != "$L_OLD_VER" ]; then
            mv "$L_TEMP" "$L_FILE"
            # 注意这里要读取之前的 FINAL_LOG 再次累加
            echo "FINAL_LOG=${FINAL_LOG}HypergryphLauncher ($L_OLD_VER -> $L_NEW_VER) " >> $GITHUB_ENV
          else
            rm -f "$L_TEMP"
          fi

      - name: Commit and Push
        run: |
          # 清洗日志格式：将空格换成逗号并去掉末尾逗号
          CLEAN_LOG=$(echo "$FINAL_LOG" | sed 's/ $//; s/ /, /g')
          
          if [ -z "$CLEAN_LOG" ]; then
            echo "没有任何版本变动，跳过提交。"
          else
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            
            git add links/*.json
            
            BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
            echo "准备提交: 更新: $CLEAN_LOG $BEIJING_TIME UTC+8"
            
            git commit -m "更新: $CLEAN_LOG $BEIJING_TIME UTC+8"
            git pull --rebase origin main
            git push origin main
          fi
