name: Update Game Links

on:
  schedule:
    - cron: '0 * * * *' # 每小时自动运行一次
  workflow_dispatch:      # 允许手动触发

# 防止多个任务同时运行导致冲突
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 确保 Action 有权限推送代码到仓库
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史以确保 rebase 成功

      - name: Fetch Data and Create Files
        run: |
          # 创建文件夹
          mkdir -p links

          # 1. 处理游戏列表 (POST 请求)
          # 格式: "文件名;AppCode"
          GAMES=(
            "Arknights;GzD1CpaWgmSq1wew"
            "Endfield;6LL0KJuqHBVz33WK"
            "POPUCOM;Vp2jukCCSUGztqli"
          )

          for game in "${GAMES[@]}"; do
            NAME=$(echo $game | cut -d';' -f1)
            CODE=$(echo $game | cut -d';' -f2)
            echo "正在获取游戏数据: $NAME ($CODE)..."

            curl -s -X POST "https://launcher.hypergryph.com/api/proxy/batch_proxy" \
              -H "Content-Type: application/json" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" \
              -d "{
                \"proxy_reqs\": [
                  {
                    \"kind\": \"get_latest_game\",
                    \"get_latest_game_req\": {
                      \"appcode\": \"$CODE\",
                      \"channel\": \"1\",
                      \"sub_channel\": \"1\",
                      \"version\": \"\",
                      \"launcher_appcode\": \"\"
                    }
                  }
                ]
              }" | jq '.' > "links/${NAME}.json"
          done

          # 2. 处理启动器 (GET 请求)
          echo "正在获取启动器数据..."
          curl -s -X GET "https://launcher.hypergryph.com/api/launcher/get_latest?appcode=abYeZZ16BPluCFyT&channel=1" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" \
            | jq '.' > "links/HypergryphLauncher.json"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加所有 links 目录下的 json 文件
          git add links/*.json
          
          # 检查是否有内容变化
          if git diff --staged --quiet; then
            echo "数据未发生变化，跳过本次更新。"
          else
            # 先提交到本地分支
            git commit -m "自动更新游戏数据: $(date +'%Y-%m-%d %H:%M')"
            
            # 使用 rebase 模式拉取远程更新，确保提交历史是一条直线且不会冲突
            git pull --rebase origin main
            
            # 推送到远程仓库
            git push origin main
          fi
