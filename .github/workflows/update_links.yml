name: Update Game Links

on:
  schedule:
    - cron: '0 * * * *' # 每小时运行一次
  workflow_dispatch:      # 允许手动触发

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    permissions: # 显式声明权限，防止 403 错误
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Data and Create Files
        run: |
          mkdir -p links

          # 1. 处理游戏列表 (POST 请求)
          GAMES=(
            "Arknights;GzD1CpaWgmSq1wew"
            "Endfield;6LL0KJuqHBVz33WK"
            "POPUCOM;Vp2jukCCSUGztqli"
          )

          for game in "${GAMES[@]}"; do
            NAME=$(echo $game | cut -d';' -f1)
            CODE=$(echo $game | cut -d';' -f2)
            echo "正在获取游戏数据: $NAME..."

            curl -s -X POST "https://launcher.hypergryph.com/api/proxy/batch_proxy" \
              -H "Content-Type: application/json" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" \
              -d "{
                \"proxy_reqs\": [
                  {
                    \"kind\": \"get_latest_game\",
                    \"get_latest_game_req\": {
                      \"appcode\": \"$CODE\",
                      \"channel\": \"1\",
                      \"sub_channel\": \"1\",
                      \"version\": \"\",
                      \"launcher_appcode\": \"\"
                    }
                  }
                ]
              }" | jq '.' > "links/${NAME}.json"
          done

          # 2. 处理启动器 (GET 请求)
          echo "正在获取启动器数据..."
          curl -s -X GET "https://launcher.hypergryph.com/api/launcher/get_latest?appcode=abYeZZ16BPluCFyT&channel=1" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" \
            | jq '.' > "links/HypergryphLauncher.json"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 先拉取最新改动，防止 push 被拒绝
          git pull --rebase origin main
          
          git add links/*.json
          
          if git diff --staged --quiet; then
            echo "内容无变化，跳过提交。"
          else
            git commit -m "自动更新数据 (含启动器): $(date +'%Y-%m-%d %H:%M')"
            git push origin main
          fi
