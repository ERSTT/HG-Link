name: Update Game Links Global

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch and Compare
        run: |
          mkdir -p links-global
          # 创建一个临时文件来存储日志，避免环境变量在循环中覆盖
          touch update_msg.txt

          process_game() {
            local NAME=$1
            local CODE=$2
            local FILE="links-global/${NAME}.json"
            local TEMP_FILE="temp_${NAME}.json"
            
            echo "--- 正在处理 $NAME ---"
            
            curl -s -X POST "https://launcher.gryphline.com/api/proxy/batch_proxy" \
              -H "Content-Type: application/json" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" \
              -d "{\"proxy_reqs\":[{\"kind\":\"get_latest_game\",\"get_latest_game_req\":{\"appcode\":\"$CODE\",\"channel\":\"6\",\"sub_channel\":\"6\",\"version\":\"\",\"launcher_appcode\":\"\"}}]}" | jq -S '.' > "$TEMP_FILE"

            NEW_VER=$(jq -r '.proxy_rsps[0].get_latest_game_rsp.version // empty' "$TEMP_FILE")
            
            # 如果文件不存在，旧版本设为 None
            if [ -f "$FILE" ]; then
              OLD_VER=$(jq -r '.proxy_rsps[0].get_latest_game_rsp.version // empty' "$FILE")
            else
              OLD_VER="None"
            fi

            echo "[$NAME] 旧版本: $OLD_VER | 新版本: $NEW_VER"

            # 只要新版本不为空且与旧版本不同（包括 None -> 0.0.0）
            if [ -n "$NEW_VER" ] && [ "$NEW_VER" != "$OLD_VER" ]; then
              mv "$TEMP_FILE" "$FILE"
              echo "${NAME} ($OLD_VER -> ${NEW_VER})" >> update_msg.txt
            else
              rm -f "$TEMP_FILE"
            fi
          }

          # 1. 运行游戏处理
          #process_game "Arknights" ""
          process_game "Endfield" "YDUTE5gscDZ229CW"
          #process_game "POPUCOM" ""

          # 2. 处理启动器
          echo "--- 正在处理 Launcher ---"
          L_FILE="links-global/GRYPHLINK.json"
          L_TEMP="temp_launcher.json"
          curl -s -X GET "https://launcher.gryphline.com/api/launcher/get_latest?appcode=TiaytKBUIEdoEwRT&channel=6" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.15.8 Chrome/87.0.4280.144 Safari/537.36" | jq -S '.' > "$L_TEMP"
          
          L_NEW_VER=$(jq -r '.version // empty' "$L_TEMP")
          L_OLD_VER=$( [ -f "$L_FILE" ] && jq -r '.version // empty' "$L_FILE" || echo "None" )

          if [ -n "$L_NEW_VER" ] && [ "$L_NEW_VER" != "$L_OLD_VER" ]; then
            mv "$L_TEMP" "$L_FILE"
            echo "GRYPHLINK ($L_OLD_VER -> $L_NEW_VER)" >> update_msg.txt
          else
            rm -f "$L_TEMP"
          fi

          # 将最终日志合并为一行并存入环境变量
          if [ -f update_msg.txt ]; then
            FINAL_LOG=$(paste -sd "," update_msg.txt | sed 's/,/, /g')
            echo "COMMIT_MSG=$FINAL_LOG" >> $GITHUB_ENV
          fi

      - name: Commit and Push
        run: |
          if [ -z "$COMMIT_MSG" ]; then
            echo "没有任何变动。"
          else
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            
            git add links-global/*.json
            
            BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
            git commit -m "update: $COMMIT_MSG $BEIJING_TIME UTC+8"
            git pull --rebase origin main
            git push origin main
          fi
